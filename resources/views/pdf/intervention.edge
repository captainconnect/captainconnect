<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <style>
    body { font-family: Arial, sans-serif; font-size: 12px; color: #111; }
    h1 { font-size: 18px; margin: 0 0 6px; }
    h2 { font-size: 14px; margin: 18px 0 8px; }
    .muted { color: #555; }
    .small { font-size: 11px; }
    .box { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .badge { display: inline-block; border: 1px solid #ddd; border-radius: 999px; padding: 2px 8px; font-size: 11px; }
    ul { margin: 6px 0 0 18px; padding: 0; }
    li { margin: 2px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 6px; vertical-align: top; }
    th { text-align: left; font-size: 11px; color: #333; background: #fafafa; }
    .nowrap { white-space: nowrap; }
    .page-break { page-break-before: always; }
    tr { page-break-inside: avoid; }
    
    /* Style spécifique pour le tableau des techniciens */
    .tech-table { width: auto; min-width: 250px; margin-top: 10px; border: 1px solid #eee; }
    .tech-table th, .tech-table td { padding: 4px 8px; border: 1px solid #eee; }
    .text-right { text-align: right; }
  </style>
</head>

<body>

  <h1>Fiche d’intervention — {{ title }}</h1>
  <div class="muted small">
    @if(meta?.status)
      <span class="badge">{{ meta.status === "IN_PROGRESS" ? "En cours" : meta.status === "SUSPENDED" ? "Suspendue" : "Terminé" }}</span>
    @endif
    @if(meta?.priority)
      <span class="badge">Priorité {{ meta.priority === "LOW" ? "basse" : meta.priority === "NORMAL" ? "normale" : meta.priority === "HIGH" ? "haute" : "très haute"   }}</span>
    @endif
    @if(meta?.progress !== undefined)
      <span class="badge">Progression : {{ meta.progress }}%</span>
    @endif
  </div>

  <div class="grid" style="margin-top: 10px;">
    <div class="box">
      <div><strong>Bateau :</strong> {{ boat?.name ?? '-' }}</div>
      @if(boat?.contact)
        <div><strong>Contact :</strong> {{ boat.contact.name ?? '-' }}</div>
        @if(boat.contact.email)
          <div><strong>Email :</strong> {{ boat.contact.email }}</div>
        @endif
        @if(boat.contact.phone)
          <div><strong>Tél :</strong> {{ boat.contact.phone }}</div>
        @endif
      @endif
    </div>

    <div class="box">
      <div class="muted small">
        Document généré le {{ new Date().toLocaleDateString('fr-FR') }}
      </div>
    </div>
  </div>

  <h2>Travaux demandés</h2>

  @if(!requestedWorks || requestedWorks.length === 0)
    <div class="box muted">Aucun travail demandé.</div>
  @else
    @each(group in requestedWorks)
      <div class="box" style="margin-bottom: 10px;">
        <div><strong>{{ group.name }} :</strong></div>
        <ul>
          @each(t in group.tasks)
            <li>
              {{ t.name }}
              @if(t.details)
                <div class="muted small">{{ t.details }}</div>
              @endif
            </li>
          @endeach
        </ul>
      </div>
    @endeach
  @endif

  <div class="page-break"></div>

  <h2>Travaux effectués</h2>

  <table>
    <thead>
      <tr>
        <th class="nowrap" style="width: 12%;">Date</th>
        <th style="width: 12%;">Tech</th>
        <th>Travaux effectués</th>
        <th style="width: 18%;">Matériel utilisé</th>
        <th class="nowrap" style="width: 10%;">Heures</th>
      </tr>
    </thead>
    <tbody>
      @if(!performedWorks || performedWorks.length === 0)
        <tr>
          <td colspan="5" class="muted">Aucun travail renseigné.</td>
        </tr>
      @else
        @each(row in performedWorks)
          <tr>
            <td class="nowrap">{{ row.date }}</td>
            <td>{{ row.initials || '-' }}</td>
            <td>
              @if(row.taskGroupName || row.taskName)
                <div class="muted small">
                  @if(row.taskGroupName)
                    {{ row.taskGroupName }}
                  @endif

                  @if(row.taskName)
                    • {{ row.taskName }}
                  @endif
                </div>
              @endif
              <div>{{ row.workDone }}</div>
            </td>
            <td>{{ row.usedMaterials ?? '-' }}</td>
            <td class="nowrap">{{ row.hours ?? '-' }}</td>
          </tr>
        @endeach
      @endif
    </tbody>
  </table>

  @if(technicianTable && technicianTable.length > 0)
    <div style="margin-top: 30px;">
      <h2 style="margin-bottom: 5px;">Récapitulatif des heures</h2>
      <table class="tech-table">
        <thead>
          <tr>
            <th>Technicien</th>
            <th class="text-right">Total</th>
          </tr>
        </thead>
        <tbody>
          @each(tech in technicianTable)
            <tr>
              <td>{{ tech.name }}</td>
              <td class="text-right"><strong>{{ tech.total }}</strong></td>
            </tr>
          @endeach
        </tbody>
      </table>
    </div>
  @endif

</body>
</html>